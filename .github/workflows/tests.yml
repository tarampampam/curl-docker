name: tests

on:
  push:
    branches: [master, main]
    paths-ignore: ['**.md']
    tags-ignore: ['**']
  pull_request:
    paths-ignore: ['**.md']

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/curl # GitHub registry
  DOCKER_IMAGE_NAME: tarampampam/curl # DockerHub registry

jobs:
  gitleaks:
    name: üîê Check for GitLeaks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with: {fetch-depth: 0}

      - uses: gacts/gitleaks@v1

  build-image:
    name: üèóÔ∏è Build the image (${{ matrix.platform }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - {platform: linux/amd64, name: amd64}
#          - {platform: linux/arm64, name: arm64}
#          - {platform: linux/arm/v6, name: armv6}
#          - {platform: linux/arm/v7, name: armv7}
#          - {platform: linux/386, name: 386}
#          - {platform: linux/s390x, name: s390x}
#          - {platform: linux/ppc64le, name: ppc64le}
    env:
      IMAGE_TAG: ${{ github.sha }}
      IMAGE_TAG_ALPINE: ${{ github.sha }}-alpine
    steps:
      - uses: actions/checkout@v3

      - if: ${{ matrix.platform != 'linux/amd64' }}
        run: sudo podman run --rm --privileged multiarch/qemu-user-static --reset -p yes

      - name: Build the scratch image
        run: |
          podman build --platform "${{ matrix.platform }}" --tag "$GITHUB_IMAGE_NAME:$IMAGE_TAG" .
          podman save "$GITHUB_IMAGE_NAME:$IMAGE_TAG" > ./image.tar

      - uses: actions/upload-artifact@v3
        with: {name: 'image-${{ matrix.name }}', path: ./image.tar, retention-days: 1}

      - name: Build the alpine image
        run: |
          podman build --platform "${{ matrix.platform }}" --tag "$GITHUB_IMAGE_NAME:$IMAGE_TAG_ALPINE" \
            --build-arg "BASE_IMAGE=docker.io/library/alpine:latest" .
          podman save "$GITHUB_IMAGE_NAME:$IMAGE_TAG_ALPINE" > ./image.tar

      - uses: actions/upload-artifact@v3
        with: {name: 'image-${{ matrix.name }}-alpine', path: ./image.tar, retention-days: 1}

  create-manifest:
    name: ‚úç Create the manifest
    runs-on: ubuntu-latest
    needs: [build-image]
    steps:
      - {uses: actions/download-artifact@v3, id: download, with: {path: images}}

      - name: Load the images
        run: for d in "${{ steps.download.outputs.download-path }}"/; do podman load < "$d/image.tar"; done

#      - uses: gacts/install-podman@v1
#
#      - name: Login into ghcr.io
#        uses: gacts/run-and-post-run@v1
#        with:
#          run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login -u "${{ github.actor }}" --password-stdin ghcr.io
#          post: podman logout ghcr.io
#
#      - {uses: gacts/github-slug@v1, id: slug}
#
#      - name: Create the manifest
#        uses: gacts/run-and-post-run@v1
#        env:
#          IMAGE_TAG: ${{ steps.slug.outputs.version }}
#        with:
#          run: podman manifest create "$GITHUB_IMAGE_NAME:$IMAGE_TAG"
#            "$GITHUB_IMAGE_NAME:amd64-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:arm64-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:armv6-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:armv7-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:386-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:s390x-${{ steps.slug.outputs.version }}"
#            "$GITHUB_IMAGE_NAME:ppc64le-${{ steps.slug.outputs.version }}"
#          post: podman manifest push --all "$GITHUB_IMAGE_NAME:$IMAGE_TAG" "docker://$GITHUB_IMAGE_NAME:$IMAGE_TAG"

#  scan-image:
#    name: Scan docker image
#    runs-on: ubuntu-latest
#    needs: [build-image]
#    steps:
#      - uses: actions/download-artifact@v3
#        with:
#          name: docker-image
#          path: .artifact
#
#      - working-directory: .artifact
#        run: docker load < docker-image.tar
#
#      - uses: anchore/scan-action@v3 # action page: <https://github.com/anchore/scan-action>
#        with:
#          image: curl:local
#          fail-build: true
#          severity-cutoff: low # negligible, low, medium, high or critical
#
#  try-to-use:
#    name: Use docker image
#    runs-on: ubuntu-latest
#    needs: [build-image]
#    steps:
#      - uses: actions/download-artifact@v3
#        with:
#          name: docker-image
#          path: .artifact
#
#      - name: Prepare image to run
#        working-directory: .artifact
#        run: docker load < docker-image.tar
#
#      - name: Try to run (github.com)
#        run: docker run --rm curl:local --fail https://github.com/
#
#      - name: Try to run (1.1.1.1)
#        run: docker run --rm curl:local --fail https://1.1.1.1/
#
#      - name: Try to run (ppa.launchpad.net)
#        run: docker run --rm curl:local --fail http://ppa.launchpad.net/
#
#      - name: Should exit with code 1
#        run: |
#          docker run --rm curl:local --fail "https://httpbin.org/status/401" || ec=$?
#          test $ec -eq 1 && echo "all is ok (code = $ec)" || ( echo "Wrong exit code: $ec"; exit 1 )

#      - uses: gacts/install-podman@v1
#        with: {qemu: true}

#      - name: Login into ghcr.io
#        uses: gacts/run-and-post-run@v1
#        with:
#          run: echo "${{ secrets.GITHUB_TOKEN }}" | podman login -u "${{ github.actor }}" --password-stdin ghcr.io
#          post: podman logout ghcr.io

#      - {uses: gacts/github-slug@v1, id: slug}


#      - name: Check the image
#        run: |
#          podman --root /tmp/pd run \
#            --rm --entrypoint '' "localhost/curl:${{ steps.image-tag.outputs.slug }}" \
#            sh && exit 1 || true
#          podman --root /tmp/pd run \
#            --rm "localhost/curl:${{ steps.image-tag.outputs.slug }}" \
#            --version
#
#      - name: Check is alpine image
#        run: |
#          podman --root /tmp/pd run \
#            --rm --entrypoint '' "localhost/curl:${{ steps.image-tag.outputs.slug }}-alpine" \
#            sh -c 'cat /etc/os-release'
#          podman --root /tmp/pd run \
#            --rm "localhost/curl:${{ steps.image-tag.outputs.slug }}-alpine" \
#            --version
